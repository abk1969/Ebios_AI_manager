import React, { useState, useEffect } from 'react';
import { useDispatch, useSelector } from 'react-redux';
import { useSearchParams, useParams } from 'react-router-dom';
import { RootState } from '../../store';
import { addBusinessValue, setBusinessValues } from '../../store/slices/businessValuesSlice';
import { addSupportingAsset, setSupportingAssets } from '../../store/slices/supportingAssetsSlice';
import { getBusinessValuesByMission, createBusinessValue, updateBusinessValue } from '../../services/firebase/businessValues';
import { getSupportingAssets, getSupportingAssetsByMission, createSupportingAsset, updateSupportingAsset } from '../../services/firebase/supportingAssets';
import { getDreadedEvents, createDreadedEvent, updateDreadedEvent, DreadedEventUtils } from '../../services/firebase/dreadedEvents';
import { getMissionById, updateMission } from '../../services/firebase/missions';
import {
  EBIOS_SCALES,
  WORKSHOP_VALIDATION_CRITERIA,
  EbiosUtils,
  IMPACT_TYPES,
  SUPPORTING_ASSET_TYPES,
  SECURITY_LEVELS
} from '../../lib/ebios-constants';
import { EnhancedSuggestionsService, type EnhancedSuggestion } from '../../services/ai/EnhancedSuggestionsService';
import { ANSSIValidationService } from '../../services/validation/ANSSIValidationService';
import Workshop1Tutorial from '../../components/tutorials/Workshop1Tutorial';
import Button from '../../components/ui/button';
import {
  Database,
  AlertTriangle,
  Server,
  Plus,
  CheckCircle,
  AlertCircle,
  Info,
  Target,
  Shield,
  RefreshCw
} from 'lucide-react';
import LoadingSpinner from '../../components/common/LoadingSpinner';
import WorkshopNavigation from '../../components/workshops/WorkshopNavigation';
import AddBusinessValueModal from '../../components/business-values/AddBusinessValueModal';
import AddDreadedEventModal from '../../components/business-values/AddDreadedEventModal';
import AddSupportingAssetModal from '../../components/supporting-assets/AddSupportingAssetModal';
import AICoherenceIndicator from '../../components/ai/AICoherenceIndicator';
import ANSSIValidationReport from '../../components/validation/ANSSIValidationReport';
import StandardWorkshopHeader from '../../components/workshops/StandardWorkshopHeader';
import StandardValidationPanel from '../../components/workshops/StandardValidationPanel';
import WorkshopGuide from '../../components/workshops/WorkshopGuide';
import Workshop1Guide from '../../components/workshops/Workshop1Guide';
import AISuggestionPanel from '../../components/ai/AISuggestionPanel';
import Workshop1Actions from '../../components/workshops/Workshop1Actions';
import AISuggestionsExplainer from '../../components/ai/AISuggestionsExplainer';
import EbiosMethodologyValidator from '../../components/validation/EbiosMethodologyValidator';
import { StandardEbiosValidation } from '../../services/validation/StandardEbiosValidation';
import { ResponsiveContainer, CardsGrid, MetricsGrid } from '../../components/layout/ResponsiveGrid';
import DataQualityAlert from '../../components/ai/DataQualityAlert';
import DataQualityFixModal from '../../components/ai/DataQualityFixModal';
import AIOverviewDashboard from '../../components/ai/AIOverviewDashboard';
import DependencyGraph from '../../components/ai/DependencyGraph';
import EbiosGuidancePanel from '../../components/ai/EbiosGuidancePanel';
import QualityMetricsPanel from '../../components/ai/QualityMetricsPanel';
import { dataQualityDetector } from '../../services/ai/DataQualityDetector';
import { a2aDataQualityService } from '../../services/ai/A2ADataQualityService';
import { dataQualityCorrectionManager } from '../../services/ai/DataQualityCorrectionManager';
import type {
  BusinessValue,
  SupportingAsset,
  DreadedEvent,
  Mission,
  GravityScale,
  WorkshopValidation
} from '../../types/ebios';

const Workshop1 = () => {
  const [searchParams] = useSearchParams();
  const params = useParams();
  // üîß CORRECTION: Support des deux m√©thodes de r√©cup√©ration du missionId
  const missionId = params.missionId || searchParams.get('missionId');

  // üîç DEBUG TEMPORAIRE (en mode d√©veloppement uniquement)
  if (import.meta.env.DEV) {
    console.log('üîç Workshop1 DEBUG:', {
      'params': params,
      'params.missionId': params.missionId,
      'searchParams.get(missionId)': searchParams.get('missionId'),
      'missionId final': missionId,
      'URL actuelle': window.location.href
    });
  }
  const dispatch = useDispatch();
  const businessValues = useSelector((state: RootState) => state.businessValues.businessValues);
  const supportingAssets = useSelector((state: RootState) => state.supportingAssets.assets);
  
  // √âtats pour les nouvelles entit√©s EBIOS RM
  const [dreadedEvents, setDreadedEvents] = useState<DreadedEvent[]>([]);
  const [selectedBusinessValueId, setSelectedBusinessValueId] = useState<string | null>(null);
  const [selectedEventId, setSelectedEventId] = useState<string | null>(null);
  
  // √âtats pour les modales
  const [isAddValueModalOpen, setIsAddValueModalOpen] = useState(false);
  const [isAddAssetModalOpen, setIsAddAssetModalOpen] = useState(false);
  const [isAddEventModalOpen, setIsAddEventModalOpen] = useState(false);

  // √âtats pour la gestion des modifications
  const [editingBusinessValue, setEditingBusinessValue] = useState<BusinessValue | null>(null);
  const [editingSupportingAsset, setEditingSupportingAsset] = useState<SupportingAsset | null>(null);
  const [editingDreadedEvent, setEditingDreadedEvent] = useState<DreadedEvent | null>(null);
  const [previousState, setPreviousState] = useState<{
    businessValues: BusinessValue[];
    supportingAssets: SupportingAsset[];
    dreadedEvents: DreadedEvent[];
    timestamp: string;
  } | null>(null);
  
  // √âtats g√©n√©raux
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [mission, setMission] = useState<Mission | null>(null);
  const [validationResults, setValidationResults] = useState<WorkshopValidation[]>([]);
  const [showHelp, setShowHelp] = useState(false);

  // üÜï √âtats pour les suggestions IA am√©lior√©es
  const [enhancedSuggestions, setEnhancedSuggestions] = useState<EnhancedSuggestion[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedSuggestion, setSelectedSuggestion] = useState<EnhancedSuggestion | null>(null);

  // üÜï √âtat pour le tutoriel guid√©
  const [showTutorial, setShowTutorial] = useState(false);

  // üÜï √âtat pour la validation ANSSI stricte
  const [anssiValidation, setAnssiValidation] = useState<any>(null);
  const [showAnssiReport, setShowAnssiReport] = useState(false);
  const [standardValidation, setStandardValidation] = useState<any>(null);

  // üÜï √âtats pour les suggestions IA de correction
  const [showAISuggestions, setShowAISuggestions] = useState(false);
  const [selectedCriterion, setSelectedCriterion] = useState<string>('');

  // üîç NOUVEAU : √âtats pour la d√©tection de qualit√© des donn√©es
  const [dataQualityIssues, setDataQualityIssues] = useState<any[]>([]);
  const [showDataQualityAlert, setShowDataQualityAlert] = useState(false);
  const [selectedDataQualityIssue, setSelectedDataQualityIssue] = useState<any>(null);
  const [showDataQualityFixModal, setShowDataQualityFixModal] = useState(false);
  const [entityToFix, setEntityToFix] = useState<any>(null);
  const [lastAnalysisTimestamp, setLastAnalysisTimestamp] = useState<number>(0);
  const [dataChangeCounter, setDataChangeCounter] = useState<number>(0);

  // üÜï NOUVEAUX √âTATS POUR LES AM√âLIORATIONS UI/UX
  const [showAIDashboard, setShowAIDashboard] = useState(false);
  const [showDependencyGraph, setShowDependencyGraph] = useState(false);
  const [showGuidancePanel, setShowGuidancePanel] = useState(true);
  const [guidancePanelCollapsed, setGuidancePanelCollapsed] = useState(false);
  const [showQualityMetrics, setShowQualityMetrics] = useState(false);

  // üîó Configurer la r√©f√©rence au gestionnaire de corrections
  React.useEffect(() => {
    dataQualityDetector.setCorrectionManager((stableKey: string) =>
      dataQualityCorrectionManager.getHistory(stableKey)
    );
  }, []);

  // üîç NOUVEAU : Surveillance des changements de donn√©es (D√âSACTIV√âE TEMPORAIREMENT)
  React.useEffect(() => {
    console.log('üìä SURVEILLANCE D√âSACTIV√âE - Donn√©es modifi√©es:', {
      businessValues: businessValues.length,
      dreadedEvents: dreadedEvents.length,
      supportingAssets: supportingAssets.length,
      timestamp: new Date().toLocaleTimeString()
    });
    // D√©sactiv√© temporairement pour debug
    // setDataChangeCounter(prev => prev + 1);
  }, [businessValues, dreadedEvents, supportingAssets]);

  // üîç NOUVEAU : Analyse automatique D√âSACTIV√âE TEMPORAIREMENT
  React.useEffect(() => {
    console.log('üîÑ ANALYSE AUTOMATIQUE D√âSACTIV√âE - Donn√©es actuelles:', {
      businessValues: businessValues.length,
      dreadedEvents: dreadedEvents.length,
      supportingAssets: supportingAssets.length
    });

    // D√©sactiv√© temporairement pour debug
    // if (businessValues.length > 0 || dreadedEvents.length > 0 || supportingAssets.length > 0) {
    //   analyzeDataQuality(businessValues, dreadedEvents, supportingAssets);
    // }
  }, [businessValues, dreadedEvents, supportingAssets]);

  if (!missionId) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <AlertTriangle className="mx-auto h-12 w-12 text-red-400 mb-4" />
          <h3 className="text-lg font-medium text-gray-900 mb-2">ID de mission requis</h3>
          <p className="text-gray-500 mb-6">S√©lectionnez d'abord une mission pour acc√©der √† l'Atelier 1</p>

          {/* TEST D'URGENCE */}
          <div className="mb-4">
            <button
              style={{
                padding: '12px 24px',
                backgroundColor: '#dc2626',
                color: 'white',
                border: 'none',
                borderRadius: '6px',
                cursor: 'pointer',
                fontSize: '16px',
                fontWeight: 'bold'
              }}
              onClick={() => {
                console.log('üö® TEST D\'URGENCE - Clic d√©tect√© !');
                alert('TEST D\'URGENCE FONCTIONNE !');
              }}
            >
              üö® TEST D'URGENCE
            </button>
          </div>

          <Button
            onClick={() => window.history.back()}
            variant="secondary"
          >
            Retour
          </Button>
        </div>
      </div>
    );
  }

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [missionData, values, assets, events] = await Promise.all([
          getMissionById(missionId),
          getBusinessValuesByMission(missionId),
          getSupportingAssetsByMission(missionId),
          getDreadedEvents(missionId)
        ]);
        
        if (missionData) {
          setMission(missionData);
          dispatch(setBusinessValues(values));
          dispatch(setSupportingAssets(assets));
          setDreadedEvents(events);
          validateWorkshopCompletion(values, assets, events);
        } else {
          setError('Mission non trouv√©e');
        }
      } catch (error) {
        console.error('Erreur lors du chargement des donn√©es:', error);
        setError('√âchec du chargement des donn√©es de l\'atelier');
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, [missionId, dispatch]);

  // üÜï AM√âLIORATION: D√©tection des nouveaux utilisateurs pour le tutoriel
  useEffect(() => {
    const tutorialCompleted = localStorage.getItem('workshop1-tutorial-completed');
    const isFirstVisit = businessValues.length === 0 && dreadedEvents.length === 0 && supportingAssets.length === 0;

    if (!tutorialCompleted && isFirstVisit && !loading) {
      // Attendre un peu pour que l'interface soit charg√©e
      setTimeout(() => {
        setShowTutorial(true);
      }, 1000);
    }
  }, [businessValues, dreadedEvents, supportingAssets, loading]);

  // Validation selon crit√®res EBIOS RM Atelier 1
  const validateWorkshopCompletion = (
    values: BusinessValue[], 
    assets: SupportingAsset[], 
    events: DreadedEvent[]
  ) => {
    const criteria = WORKSHOP_VALIDATION_CRITERIA[1];
    const results: WorkshopValidation[] = criteria.map(criterion => {
      let met = false;
      let evidence = '';

      switch (criterion.criterion) {
        case 'Valeurs m√©tier identifi√©es':
          met = values.length >= 1;
          evidence = `${values.length} valeur(s) m√©tier identifi√©e(s)`;
          break;
        case 'Actifs supports cartographi√©s':
          // üîß CORRECTION: Validation durcie selon ANSSI
          const coveredValues = values.filter(v => assets.some(a => a.businessValueId === v.id)).length;
          const coverageRate = values.length > 0 ? (coveredValues / values.length) * 100 : 0;
          met = assets.length >= 1 && coverageRate >= 50; // Au moins 50% des valeurs m√©tier doivent avoir des actifs
          evidence = assets.length > 0 ?
            `${assets.length} actif(s) support - ${Math.round(coverageRate)}% valeurs couvertes` :
            'Aucun actif support identifi√© - Requis pour continuer';
          break;
        case '√âv√©nements redout√©s d√©finis':
          // üîß CORRECTION: Validation durcie selon ANSSI
          const coveredByEvents = values.filter(v => events.some(e => e.businessValueId === v.id)).length;
          const eventCoverageRate = values.length > 0 ? (coveredByEvents / values.length) * 100 : 0;
          met = events.length >= 1 && eventCoverageRate >= 30; // Au moins 30% des valeurs m√©tier doivent avoir des √©v√©nements redout√©s
          evidence = events.length > 0 ?
            `${events.length} √©v√©nement(s) redout√©(s) - ${Math.round(eventCoverageRate)}% valeurs couvertes` :
            'Aucun √©v√©nement redout√© d√©fini - Requis selon EBIOS RM';
          break;
        case 'Socle de s√©curit√© √©valu√©':
          // üîß CORRECTION: Validation durcie selon ANSSI
          const classifiedAssets = assets.filter(a => a.securityLevel).length;
          const classificationRate = assets.length > 0 ? (classifiedAssets / assets.length) * 100 : 0;
          met = assets.length > 0 && classificationRate >= 70; // Au moins 70% des actifs doivent √™tre classifi√©s
          evidence = assets.length > 0 ?
            `${Math.round(classificationRate)}% actifs classifi√©s (${classifiedAssets}/${assets.length})` :
            'Aucun actif √† √©valuer - Cr√©er d\'abord des actifs supports';
          break;
        case 'Parties prenantes identifi√©es':
          // üîß CORRECTION: Validation assouplie pour faciliter l'utilisation
          const valuesWithStakeholders = values.filter(v => v.stakeholders && v.stakeholders.length > 0).length;
          const stakeholderRate = values.length > 0 ? (valuesWithStakeholders / values.length) * 100 : 0;
          // üîß ASSOUPLISSEMENT: Crit√®re optionnel si au moins une valeur m√©tier existe
          met = values.length > 0; // Simplement avoir des valeurs m√©tier suffit
          evidence = valuesWithStakeholders > 0 ?
            `${Math.round(stakeholderRate)}% valeurs avec parties prenantes (${valuesWithStakeholders}/${values.length})` :
            `${values.length} valeur(s) m√©tier - Parties prenantes optionnelles`;
          break;
      }

      return {
        criterion: criterion.criterion,
        required: criterion.required,
        met,
        evidence
      };
    });

    setValidationResults(results);

    // üÜï AM√âLIORATION: Validation ANSSI stricte
    const anssiResult = ANSSIValidationService.validateWorkshop1(values, events, assets);
    setAnssiValidation(anssiResult);

    // üÜï AM√âLIORATION: Validation standardis√©e
    const standardResult = StandardEbiosValidation.validateWorkshop1(values, assets, events);
    setStandardValidation(standardResult);

    // üîç NOUVEAU : Analyse de qualit√© des donn√©es avec A2A
    analyzeDataQuality(values, events, assets).catch(error => {
      console.warn('‚ö†Ô∏è Erreur analyse qualit√©:', error);
    });
  };

  // üîç NOUVEAU : Fonction d'analyse de qualit√© des donn√©es avec A2A et filtrage des corrections
  const analyzeDataQuality = async (
    values: BusinessValue[],
    events: DreadedEvent[],
    assets: SupportingAsset[]
  ) => {
    console.log('üîç ===== D√âBUT ANALYSE QUALIT√â DES DONN√âES =====');
    console.log('üìä Donn√©es √† analyser:', { values: values.length, events: events.length, assets: assets.length });
    console.log('üïê Timestamp:', new Date().toLocaleTimeString());

    const allIssues: any[] = [];

    try {
      // üîí NOUVEAU : V√©rifier si une entit√© a des champs d√©j√† corrig√©s
      const hasUncorrectedFields = (entity: any, entityType: string) => {
        const textFields = ['name', 'description', 'category', 'criticalityLevel', 'consequences', 'type'];

        for (const fieldName of textFields) {
          const value = entity[fieldName];
          if (value && typeof value === 'string' && value.trim().length > 0) {
            const stableKey = `${entityType}:${entity.id}:${fieldName}`;
            const correctionHistory = dataQualityCorrectionManager.getHistory(stableKey);

            if (!correctionHistory || correctionHistory.correctionCount === 0) {
              // Ce champ n'a pas √©t√© corrig√©, l'entit√© peut √™tre analys√©e
              return true;
            }
          }
        }

        // Tous les champs ont √©t√© corrig√©s ou sont vides
        return false;
      };

      // ü§ñ NOUVEAU : Analyse avec orchestration A2A pour chaque entit√©

      // Analyser les valeurs m√©tier avec A2A (en filtrant les entit√©s d√©j√† corrig√©es)
      for (const bv of values) {
        // V√©rifier si cette entit√© a des champs non corrig√©s
        if (!hasUncorrectedFields(bv, 'businessValue')) {
          console.log(`üîí Valeur m√©tier ${bv.id} ignor√©e (tous les champs corrig√©s)`);
          continue;
        }

        try {
          const a2aAnalysis = await a2aDataQualityService.analyzeEntityWithA2A(
            'businessValue',
            bv,
            missionId
          );

          if (a2aAnalysis.issues.length > 0) {
            allIssues.push(...a2aAnalysis.issues.map(issue => ({
              ...issue,
              entityType: 'businessValue',
              entityId: bv.id,
              entityName: bv.name,
              // ü§ñ Enrichissement A2A
              a2aSuggestions: a2aAnalysis.suggestions.filter(s => s.field === issue.field),
              agentsUsed: a2aAnalysis.agentsUsed,
              mcpToolsUsed: a2aAnalysis.mcpToolsUsed
            })));
          }
        } catch (error) {
          console.warn(`‚ö†Ô∏è Fallback analyse classique pour BV ${bv.id}:`, error);
          // Fallback vers analyse classique
          const report = dataQualityDetector.analyzeCompleteEntity('businessValue', bv);
          if (!report.isValid) {
            allIssues.push(...report.issues.map(issue => ({
              ...issue,
              entityType: 'businessValue',
              entityId: bv.id,
              entityName: bv.name,
              fallbackUsed: true
            })));
          }
        }
      }

      // Analyser les √©v√©nements redout√©s avec A2A (en filtrant les entit√©s d√©j√† corrig√©es)
      for (const de of events) {
        // V√©rifier si cette entit√© a des champs non corrig√©s
        if (!hasUncorrectedFields(de, 'dreadedEvent')) {
          console.log(`üîí √âv√©nement redout√© ${de.id} ignor√© (tous les champs corrig√©s)`);
          continue;
        }

        try {
          const a2aAnalysis = await a2aDataQualityService.analyzeEntityWithA2A(
            'dreadedEvent',
            de,
            missionId
          );

          if (a2aAnalysis.issues.length > 0) {
            allIssues.push(...a2aAnalysis.issues.map(issue => ({
              ...issue,
              entityType: 'dreadedEvent',
              entityId: de.id,
              entityName: de.name,
              // ü§ñ Enrichissement A2A
              a2aSuggestions: a2aAnalysis.suggestions.filter(s => s.field === issue.field),
              agentsUsed: a2aAnalysis.agentsUsed,
              mcpToolsUsed: a2aAnalysis.mcpToolsUsed
            })));
          }
        } catch (error) {
          console.warn(`‚ö†Ô∏è Fallback analyse classique pour DE ${de.id}:`, error);
          // Fallback vers analyse classique
          const report = dataQualityDetector.analyzeCompleteEntity('dreadedEvent', de);
          if (!report.isValid) {
            allIssues.push(...report.issues.map(issue => ({
              ...issue,
              entityType: 'dreadedEvent',
              entityId: de.id,
              entityName: de.name,
              fallbackUsed: true
            })));
          }
        }
      }

      // Analyser les actifs supports avec A2A (en filtrant les entit√©s d√©j√† corrig√©es)
      for (const sa of assets) {
        // V√©rifier si cette entit√© a des champs non corrig√©s
        if (!hasUncorrectedFields(sa, 'supportingAsset')) {
          console.log(`üîí Actif support ${sa.id} ignor√© (tous les champs corrig√©s)`);
          continue;
        }

        try {
          const a2aAnalysis = await a2aDataQualityService.analyzeEntityWithA2A(
            'supportingAsset',
            sa,
            missionId
          );

          if (a2aAnalysis.issues.length > 0) {
            allIssues.push(...a2aAnalysis.issues.map(issue => ({
              ...issue,
              entityType: 'supportingAsset',
              entityId: sa.id,
              entityName: sa.name,
              // ü§ñ Enrichissement A2A
              a2aSuggestions: a2aAnalysis.suggestions.filter(s => s.field === issue.field),
              agentsUsed: a2aAnalysis.agentsUsed,
              mcpToolsUsed: a2aAnalysis.mcpToolsUsed
            })));
          }
        } catch (error) {
          console.warn(`‚ö†Ô∏è Fallback analyse classique pour SA ${sa.id}:`, error);
          // Fallback vers analyse classique
          const report = dataQualityDetector.analyzeCompleteEntity('supportingAsset', sa);
          if (!report.isValid) {
            allIssues.push(...report.issues.map(issue => ({
              ...issue,
              entityType: 'supportingAsset',
              entityId: sa.id,
              entityName: sa.name,
              fallbackUsed: true
            })));
          }
        }
      }

    } catch (error) {
      console.error('‚ùå Erreur analyse A2A, fallback complet:', error);

      // Fallback complet vers analyse classique
      values.forEach(bv => {
        const report = dataQualityDetector.analyzeCompleteEntity('businessValue', bv);
        if (!report.isValid) {
          allIssues.push(...report.issues.map(issue => ({
            ...issue,
            entityType: 'businessValue',
            entityId: bv.id,
            entityName: bv.name,
            fallbackUsed: true
          })));
        }
      });

      events.forEach(de => {
        const report = dataQualityDetector.analyzeCompleteEntity('dreadedEvent', de);
        if (!report.isValid) {
          allIssues.push(...report.issues.map(issue => ({
            ...issue,
            entityType: 'dreadedEvent',
            entityId: de.id,
            entityName: de.name,
            fallbackUsed: true
          })));
        }
      });

      assets.forEach(sa => {
        const report = dataQualityDetector.analyzeCompleteEntity('supportingAsset', sa);
        if (!report.isValid) {
          allIssues.push(...report.issues.map(issue => ({
            ...issue,
            entityType: 'supportingAsset',
            entityId: sa.id,
            entityName: sa.name,
            fallbackUsed: true
          })));
        }
      });
    }

    console.log('üîç ===== FIN ANALYSE QUALIT√â DES DONN√âES =====');
    console.log('üìä Probl√®mes de qualit√© d√©tect√©s (A2A):', allIssues.length);
    console.log('üìã D√©tails des probl√®mes:', allIssues);
    console.log('üïê Fin timestamp:', new Date().toLocaleTimeString());

    setDataQualityIssues(allIssues);
    setShowDataQualityAlert(allIssues.length > 0);

    console.log('‚úÖ √âtat mis √† jour - Nombre de probl√®mes:', allIssues.length);
  };

  // Fonction pour sauvegarder l'√©tat actuel avant modification
  const saveCurrentState = () => {
    setPreviousState({
      businessValues: [...businessValues],
      supportingAssets: [...supportingAssets],
      dreadedEvents: [...dreadedEvents],
      timestamp: new Date().toISOString()
    });
  };

  // Fonctions de gestion des actions
  const handleEditBusinessValue = (value: BusinessValue) => {
    setEditingBusinessValue(value);
    setIsAddValueModalOpen(true);
  };

  const handleDeleteBusinessValue = async (valueId: string) => {
    try {
      saveCurrentState();
      // TODO: Impl√©menter la suppression Firebase
      // await deleteBusinessValue(valueId);

      // Mise √† jour locale pour l'instant
      const updatedValues = businessValues.filter(v => v.id !== valueId);
      dispatch(setBusinessValues(updatedValues));

      // Supprimer aussi les actifs et √©v√©nements associ√©s
      const updatedAssets = supportingAssets.filter(a => a.businessValueId !== valueId);
      const updatedEvents = dreadedEvents.filter(e => e.businessValueId !== valueId);

      dispatch(setSupportingAssets(updatedAssets));
      setDreadedEvents(updatedEvents);

      validateWorkshopCompletion(updatedValues, updatedAssets, updatedEvents);
      setError('‚úÖ Valeur m√©tier supprim√©e avec succ√®s');
    } catch (error) {
      console.error('Erreur lors de la suppression:', error);
      setError('Erreur lors de la suppression de la valeur m√©tier');
    }
  };

  const handleEditSupportingAsset = (asset: SupportingAsset) => {
    setEditingSupportingAsset(asset);
    setSelectedBusinessValueId(asset.businessValueId);
    setIsAddAssetModalOpen(true);
  };

  const handleDeleteSupportingAsset = async (assetId: string) => {
    try {
      saveCurrentState();
      // TODO: Impl√©menter la suppression Firebase
      // await deleteSupportingAsset(assetId);

      // Mise √† jour locale pour l'instant
      const updatedAssets = supportingAssets.filter(a => a.id !== assetId);
      dispatch(setSupportingAssets(updatedAssets));

      validateWorkshopCompletion(businessValues, updatedAssets, dreadedEvents);
      setError('‚úÖ Actif support supprim√© avec succ√®s');
    } catch (error) {
      console.error('Erreur lors de la suppression:', error);
      setError('Erreur lors de la suppression de l\'actif support');
    }
  };

  const handleEditDreadedEvent = (event: DreadedEvent) => {
    setEditingDreadedEvent(event);
    setSelectedBusinessValueId(event.businessValueId);
    setIsAddEventModalOpen(true);
  };

  const handleDeleteDreadedEvent = async (eventId: string) => {
    try {
      saveCurrentState();
      // TODO: Impl√©menter la suppression Firebase
      // await deleteDreadedEvent(eventId);

      // Mise √† jour locale pour l'instant
      const updatedEvents = dreadedEvents.filter(e => e.id !== eventId);
      setDreadedEvents(updatedEvents);

      validateWorkshopCompletion(businessValues, supportingAssets, updatedEvents);
      setError('‚úÖ √âv√©nement redout√© supprim√© avec succ√®s');
    } catch (error) {
      console.error('Erreur lors de la suppression:', error);
      setError('Erreur lors de la suppression de l\'√©v√©nement redout√©');
    }
  };

  const handleResetWorkshop = async () => {
    try {
      saveCurrentState();
      // TODO: Impl√©menter la suppression Firebase compl√®te

      // R√©initialisation locale pour l'instant
      dispatch(setBusinessValues([]));
      dispatch(setSupportingAssets([]));
      setDreadedEvents([]);

      validateWorkshopCompletion([], [], []);
      setError('‚úÖ Workshop 1 r√©initialis√© avec succ√®s');
    } catch (error) {
      console.error('Erreur lors de la r√©initialisation:', error);
      setError('Erreur lors de la r√©initialisation du workshop');
    }
  };

  const handleRestorePrevious = () => {
    if (previousState) {
      dispatch(setBusinessValues(previousState.businessValues));
      dispatch(setSupportingAssets(previousState.supportingAssets));
      setDreadedEvents(previousState.dreadedEvents);
      setPreviousState(null);

      validateWorkshopCompletion(
        previousState.businessValues,
        previousState.supportingAssets,
        previousState.dreadedEvents
      );
      setError('‚úÖ √âtat pr√©c√©dent restaur√© avec succ√®s');
    }
  };

  // üîç NOUVEAU : Fonctions de correction automatique des donn√©es
  const handleAutoFixDataQuality = async (issue: any) => {
    console.log('üîß handleAutoFixDataQuality appel√© avec:', issue);

    try {
      if (!issue.suggestedValue) {
        console.log('‚ùå Pas de suggestedValue:', issue);
        setError('‚ùå Aucune correction automatique disponible pour ce probl√®me');
        return;
      }

      // üîë Initialiser le probl√®me dans le gestionnaire
      dataQualityCorrectionManager.initializeProblem(issue);

      // üîß Appliquer la correction avec le gestionnaire
      const correctionResult = dataQualityCorrectionManager.applyCorrection(
        issue,
        issue.suggestedValue,
        'auto'
      );

      if (!correctionResult.success) {
        console.warn('‚ùå Correction refus√©e:', correctionResult.error);
        setError(`‚ùå Correction impossible: ${correctionResult.error}`);
        return;
      }

      console.log('üîß Correction valid√©e par le gestionnaire:', correctionResult);

      console.log('‚úÖ Correction automatique en cours...', {
        entityType: issue.entityType,
        entityId: issue.entityId,
        field: issue.field,
        originalValue: correctionResult.preservedOriginal,
        newValue: correctionResult.newValue,
        correctionCount: correctionResult.correctionCount
      });

      saveCurrentState();

      if (issue.entityType === 'businessValue') {
        const bv = businessValues.find(v => v.id === issue.entityId);
        if (bv) {
          const updatedValue = {
            ...bv,
            [issue.field]: correctionResult.newValue,
            [`${issue.field}_original`]: correctionResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: correctionResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateBusinessValue(bv.id, updatedValue);
          const updatedValues = businessValues.map(v =>
            v.id === bv.id ? updatedValue : v
          );
          dispatch(setBusinessValues(updatedValues));
          console.log('‚úÖ Valeur m√©tier mise √† jour:', updatedValue);
          setError(`‚úÖ "${bv.name}" corrig√© automatiquement (${correctionResult.correctionCount}x)`);
        }
      } else if (issue.entityType === 'dreadedEvent') {
        const de = dreadedEvents.find(e => e.id === issue.entityId);
        if (de) {
          const updatedEvent = {
            ...de,
            [issue.field]: correctionResult.newValue,
            [`${issue.field}_original`]: correctionResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: correctionResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateDreadedEvent(de.id, updatedEvent);
          const updatedEvents = dreadedEvents.map(e =>
            e.id === de.id ? updatedEvent : e
          );
          setDreadedEvents(updatedEvents);
          setError(`‚úÖ "${de.name}" corrig√© automatiquement (${correctionResult.correctionCount}x)`);
        }
      } else if (issue.entityType === 'supportingAsset') {
        const sa = supportingAssets.find(a => a.id === issue.entityId);
        if (sa) {
          const updatedAsset = {
            ...sa,
            [issue.field]: correctionResult.newValue,
            [`${issue.field}_original`]: correctionResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: correctionResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateSupportingAsset(sa.id, updatedAsset);
          const updatedAssets = supportingAssets.map(a =>
            a.id === sa.id ? updatedAsset : a
          );
          dispatch(setSupportingAssets(updatedAssets));
          setError(`‚úÖ "${sa.name}" corrig√© automatiquement (${correctionResult.correctionCount}x)`);
        }
      }

      // üîë Marquer le probl√®me comme r√©solu dans le gestionnaire
      const stableKey = issue.stableKey || `${issue.entityType}:${issue.entityId}:${issue.field}`;

      // Supprimer le probl√®me de la liste SEULEMENT s'il est r√©solu
      setDataQualityIssues(prev => {
        const filtered = prev.filter(i => i.stableKey !== stableKey && i.id !== issue.id);
        console.log('üóëÔ∏è Probl√®me supprim√© de la liste. Restants:', filtered.length);
        return filtered;
      });

      // üö´ NE PAS relancer l'analyse imm√©diatement pour √©viter les boucles
      console.log('‚úÖ Correction termin√©e, analyse suspendue pour √©viter les boucles');

      // üîÑ Relancer l'analyse apr√®s un d√©lai pour d√©tecter de nouveaux probl√®mes
      setTimeout(() => {
        console.log('üîÑ Re-analyse apr√®s correction...');
        analyzeDataQuality(businessValues, dreadedEvents, supportingAssets).catch(error => {
          console.warn('‚ö†Ô∏è Erreur re-analyse qualit√©:', error);
        });
      }, 2000); // 2 secondes de d√©lai

    } catch (error) {
      console.error('‚ùå Erreur lors de la correction automatique:', error);
      setError('‚ùå Erreur lors de la correction automatique');
    }
  };

  const handleManualFixDataQuality = (issue: any) => {
    console.log('üîß handleManualFixDataQuality appel√© avec:', issue);

    // Trouver l'entit√© correspondante et ouvrir le modal sp√©cialis√©
    let entity = null;

    if (issue.entityType === 'businessValue') {
      entity = businessValues.find(v => v.id === issue.entityId);
    } else if (issue.entityType === 'dreadedEvent') {
      entity = dreadedEvents.find(e => e.id === issue.entityId);
    } else if (issue.entityType === 'supportingAsset') {
      entity = supportingAssets.find(a => a.id === issue.entityId);
    }

    if (entity) {
      console.log('üìù Ouverture modal de correction sp√©cialis√©:', entity);
      console.log('üéØ Champ probl√©matique:', issue.field, 'Valeur actuelle:', issue.value);

      // Ouvrir le modal sp√©cialis√©
      setSelectedDataQualityIssue(issue);
      setEntityToFix(entity);
      setShowDataQualityFixModal(true);
    } else {
      console.error('‚ùå Entit√© non trouv√©e:', issue.entityType, issue.entityId);
      setError(`‚ùå Entit√© non trouv√©e (${issue.entityType}: ${issue.entityId})`);
    }
  };

  const handleDismissDataQualityIssue = (issueId: string) => {
    setDataQualityIssues(prev => prev.filter(i => i.id !== issueId));
    if (dataQualityIssues.length <= 1) {
      setShowDataQualityAlert(false);
    }
  };

  // üîß NOUVEAU : Fonction de sauvegarde depuis le modal de correction
  const handleSaveDataQualityFix = async (updatedEntity: any) => {
    console.log('üíæ handleSaveDataQualityFix appel√© avec:', updatedEntity);

    if (!selectedDataQualityIssue) {
      console.error('‚ùå Aucun probl√®me s√©lectionn√©');
      return;
    }

    try {
      saveCurrentState();

      const entityType = selectedDataQualityIssue.entityType;

      if (entityType === 'businessValue') {
        await updateBusinessValue(updatedEntity.id, {
          ...updatedEntity,
          updatedAt: new Date().toISOString()
        });

        const updatedValues = businessValues.map(v =>
          v.id === updatedEntity.id ? updatedEntity : v
        );
        dispatch(setBusinessValues(updatedValues));
        setError(`‚úÖ "${updatedEntity.name}" modifi√© avec succ√®s`);

      } else if (entityType === 'dreadedEvent') {
        await updateDreadedEvent(updatedEntity.id, {
          ...updatedEntity,
          updatedAt: new Date().toISOString()
        });

        const updatedEvents = dreadedEvents.map(e =>
          e.id === updatedEntity.id ? updatedEntity : e
        );
        setDreadedEvents(updatedEvents);
        setError(`‚úÖ "${updatedEntity.name}" modifi√© avec succ√®s`);

      } else if (entityType === 'supportingAsset') {
        await updateSupportingAsset(updatedEntity.id, {
          ...updatedEntity,
          updatedAt: new Date().toISOString()
        });

        const updatedAssets = supportingAssets.map(a =>
          a.id === updatedEntity.id ? updatedEntity : a
        );
        dispatch(setSupportingAssets(updatedAssets));
        setError(`‚úÖ "${updatedEntity.name}" modifi√© avec succ√®s`);
      }

      // Fermer le modal
      setShowDataQualityFixModal(false);
      setSelectedDataQualityIssue(null);
      setEntityToFix(null);

      // Supprimer le probl√®me de la liste
      const stableKey = selectedDataQualityIssue.stableKey ||
        `${selectedDataQualityIssue.entityType}:${selectedDataQualityIssue.entityId}:${selectedDataQualityIssue.field}`;

      setDataQualityIssues(prev => {
        const filtered = prev.filter(i => i.stableKey !== stableKey && i.id !== selectedDataQualityIssue.id);
        console.log('üóëÔ∏è Probl√®me supprim√© apr√®s correction manuelle. Restants:', filtered.length);
        return filtered;
      });

      // Forcer la re-analyse imm√©diate apr√®s correction manuelle
      console.log('üîÑ For√ßage re-analyse apr√®s correction manuelle...');
      setLastAnalysisTimestamp(0); // Reset pour permettre une nouvelle analyse
      setDataChangeCounter(prev => prev + 1); // Forcer le d√©clenchement

      // Re-analyse diff√©r√©e pour s'assurer que les donn√©es sont bien mises √† jour
      setTimeout(() => {
        console.log('üîÑ Re-analyse diff√©r√©e apr√®s correction manuelle...');
        analyzeDataQuality(businessValues, dreadedEvents, supportingAssets).catch(error => {
          console.warn('‚ö†Ô∏è Erreur re-analyse qualit√©:', error);
        });
      }, 1500);

    } catch (error) {
      console.error('‚ùå Erreur lors de la sauvegarde:', error);
      setError('‚ùå Erreur lors de la sauvegarde des modifications');
    }
  };

  // üîÑ NOUVEAU : Fonction de restauration de la valeur originale
  const handleRestoreOriginalValue = async (issue: any) => {
    console.log('üîÑ handleRestoreOriginalValue appel√© avec:', issue);

    try {
      const stableKey = issue.stableKey || `${issue.entityType}:${issue.entityId}:${issue.field}`;

      // üîÑ Restaurer avec le gestionnaire
      const restoreResult = dataQualityCorrectionManager.restoreOriginal(stableKey);

      if (!restoreResult.success) {
        console.warn('‚ùå Restauration refus√©e:', restoreResult.error);
        setError(`‚ùå Restauration impossible: ${restoreResult.error}`);
        return;
      }

      console.log('üîÑ Restauration valid√©e par le gestionnaire:', restoreResult);

      saveCurrentState();

      if (issue.entityType === 'businessValue') {
        const bv = businessValues.find(v => v.id === issue.entityId);
        if (bv) {
          const updatedValue = {
            ...bv,
            [issue.field]: restoreResult.newValue,
            [`${issue.field}_original`]: restoreResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: restoreResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateBusinessValue(bv.id, updatedValue);
          const updatedValues = businessValues.map(v =>
            v.id === bv.id ? updatedValue : v
          );
          dispatch(setBusinessValues(updatedValues));
          setError(`üîÑ "${bv.name}" restaur√© √† la valeur originale`);
        }
      } else if (issue.entityType === 'dreadedEvent') {
        const de = dreadedEvents.find(e => e.id === issue.entityId);
        if (de) {
          const updatedEvent = {
            ...de,
            [issue.field]: restoreResult.newValue,
            [`${issue.field}_original`]: restoreResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: restoreResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateDreadedEvent(de.id, updatedEvent);
          const updatedEvents = dreadedEvents.map(e =>
            e.id === de.id ? updatedEvent : e
          );
          setDreadedEvents(updatedEvents);
          setError(`üîÑ "${de.name}" restaur√© √† la valeur originale`);
        }
      } else if (issue.entityType === 'supportingAsset') {
        const sa = supportingAssets.find(a => a.id === issue.entityId);
        if (sa) {
          const updatedAsset = {
            ...sa,
            [issue.field]: restoreResult.newValue,
            [`${issue.field}_original`]: restoreResult.preservedOriginal,
            [`${issue.field}_correctionCount`]: restoreResult.correctionCount,
            updatedAt: new Date().toISOString()
          };

          await updateSupportingAsset(sa.id, updatedAsset);
          const updatedAssets = supportingAssets.map(a =>
            a.id === sa.id ? updatedAsset : a
          );
          dispatch(setSupportingAssets(updatedAssets));
          setError(`üîÑ "${sa.name}" restaur√© √† la valeur originale`);
        }
      }

      // Supprimer le probl√®me de la liste
      setDataQualityIssues(prev => {
        const filtered = prev.filter(i => i.stableKey !== stableKey && i.id !== issue.id);
        console.log('üóëÔ∏è Probl√®me supprim√© apr√®s restauration. Restants:', filtered.length);
        return filtered;
      });

    } catch (error) {
      console.error('‚ùå Erreur lors de la restauration:', error);
      setError('‚ùå Erreur lors de la restauration de la valeur originale');
    }
  };

  const handleCreateBusinessValue = async (data: Partial<BusinessValue>) => {
    try {
      if (editingBusinessValue) {
        // Mode √©dition
        saveCurrentState();
        const updatedValue = {
          ...editingBusinessValue,
          ...data,
          updatedAt: new Date().toISOString()
        };

        // Mise √† jour Firebase
        await updateBusinessValue(editingBusinessValue.id, updatedValue);

        // Mise √† jour locale
        const updatedValues = businessValues.map(v =>
          v.id === editingBusinessValue.id ? updatedValue : v
        );
        dispatch(setBusinessValues(updatedValues));
        setEditingBusinessValue(null);
        setError('‚úÖ Valeur m√©tier modifi√©e avec succ√®s');

        // üîÑ MISE √Ä JOUR MANUELLE SIMPLE
        console.log('üîÑ Modification valeur m√©tier d√©tect√©e - Mise √† jour manuelle');

        // Lancer une nouvelle analyse apr√®s un d√©lai
        setTimeout(() => {
          console.log('üîç Re-analyse apr√®s modification valeur m√©tier');
          analyzeDataQuality(businessValues, dreadedEvents, supportingAssets)
            .then(() => console.log('‚úÖ Re-analyse termin√©e'))
            .catch(error => console.error('‚ùå Erreur re-analyse:', error));
        }, 1000);
      } else {
        // Mode cr√©ation
        const newValue = await createBusinessValue({
          name: data.name || '',
          description: data.description || '',
          category: data.category || 'primary',
          priority: data.priority || 2,
          criticalityLevel: data.criticalityLevel || 'important',
          missionId,
          dreadedEvents: [],
          supportingAssets: [],
          stakeholders: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });

        dispatch(addBusinessValue(newValue));

        // üÜï AM√âLIORATION: Suggestions enrichies avec r√©f√©rentiels (uniquement en mode cr√©ation)
        const enhancedEventSuggestions = EnhancedSuggestionsService.generateEnhancedDreadedEvents(
          newValue,
          dreadedEvents
        );

        const enhancedAssetSuggestions = EnhancedSuggestionsService.generateEnhancedSupportingAssets(
          newValue,
          supportingAssets
        );

        const allSuggestions = [...enhancedEventSuggestions, ...enhancedAssetSuggestions];

        if (allSuggestions.length > 0) {
          setEnhancedSuggestions(allSuggestions);
          setSelectedBusinessValueId(newValue.id);
          setShowSuggestions(true);
          setError(`üí° ${allSuggestions.length} suggestions enrichies disponibles pour "${newValue.name}" (ISO 27002, NIST, CIS)`);
        }
      }

      setIsAddValueModalOpen(false);
    } catch (error) {
      console.error('Erreur lors de la cr√©ation de la valeur m√©tier:', error);
      setError('√âchec de la cr√©ation de la valeur m√©tier');
    }
  };

  const handleCreateDreadedEvent = async (data: {
    name: string;
    description: string;
    impactedBusinessValues: string[];
    impactedSupportingAssets: string[];
    gravity: GravityScale;
    impactType?: 'availability' | 'integrity' | 'confidentiality' | 'authenticity' | 'non_repudiation';
    impactDescription: string;
    consequencesDescription: string;
  }) => {
    try {
      if (editingDreadedEvent) {
        // Mode √©dition
        saveCurrentState();
        const updatedEvent = {
          ...editingDreadedEvent,
          name: data.name,
          description: data.description,
          gravity: data.gravity,
          impactType: data.impactType || editingDreadedEvent.impactType,
          consequences: data.consequencesDescription,
          updatedAt: new Date().toISOString()
        };

        // Mise √† jour Firebase
        await updateDreadedEvent(editingDreadedEvent.id, updatedEvent);

        // Mise √† jour locale
        const updatedEvents = dreadedEvents.map(e =>
          e.id === editingDreadedEvent.id ? updatedEvent : e
        );
        setDreadedEvents(updatedEvents);
        setEditingDreadedEvent(null);
        setError('‚úÖ √âv√©nement redout√© modifi√© avec succ√®s');

        // üîÑ MISE √Ä JOUR MANUELLE SIMPLE
        console.log('üîÑ Modification √©v√©nement redout√© d√©tect√©e - Mise √† jour manuelle');

        // Lancer une nouvelle analyse apr√®s un d√©lai
        setTimeout(() => {
          console.log('üîç Re-analyse apr√®s modification √©v√©nement redout√©');
          analyzeDataQuality(businessValues, dreadedEvents, supportingAssets)
            .then(() => console.log('‚úÖ Re-analyse termin√©e'))
            .catch(error => console.error('‚ùå Erreur re-analyse:', error));
        }, 1000);
      } else {
        // Mode cr√©ation
        // üîß CORRECTION BUG: D√©terminer l'impact type dynamiquement
        const determineImpactType = (name: string, description: string): 'availability' | 'integrity' | 'confidentiality' | 'authenticity' | 'non_repudiation' => {
          const text = `${name} ${description}`.toLowerCase();

          if (text.includes('indisponib') || text.includes('panne') || text.includes('arr√™t')) {
            return 'availability';
          }
          if (text.includes('modifi') || text.includes('alt√©r') || text.includes('corrupt')) {
            return 'integrity';
          }
          if (text.includes('vol') || text.includes('fuite') || text.includes('divulg')) {
            return 'confidentiality';
          }
          if (text.includes('usurp') || text.includes('authentif') || text.includes('identit')) {
            return 'authenticity';
          }
          if (text.includes('r√©pudi') || text.includes('nier') || text.includes('preuve')) {
            return 'non_repudiation';
          }

          // Par d√©faut, confidentialit√© pour les donn√©es sensibles
          return 'confidentiality';
        };

        // Cr√©er un √©v√©nement redout√© pour chaque valeur m√©tier impact√©e
        for (const businessValueId of data.impactedBusinessValues) {
          const dynamicImpactType = data.impactType || determineImpactType(data.name, data.description);

          await createDreadedEvent({
            name: data.name,
            description: data.description,
            businessValueId,
            missionId,
            gravity: data.gravity,
            impactType: dynamicImpactType, // üîß CORRECTION: Impact type dynamique
            consequences: data.consequencesDescription,
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          });
        }

        // Recharger les √©v√©nements redout√©s
        const events = await getDreadedEvents(missionId);
        setDreadedEvents(events);
      }

      setIsAddEventModalOpen(false);
      setSelectedBusinessValueId(null);
    } catch (error) {
      console.error('Erreur lors de la cr√©ation/modification de l\'√©v√©nement redout√©:', error);
      setError(editingDreadedEvent ? '√âchec de la modification de l\'√©v√©nement redout√©' : '√âchec de la cr√©ation de l\'√©v√©nement redout√©');
    }
  };

  const handleCreateSupportingAsset = async (data: Partial<SupportingAsset>) => {
    if (!selectedBusinessValueId && !editingSupportingAsset) return;

    // üîß CORRECTION: Suppression des console.log de production
    const isDevelopment = import.meta.env.DEV;

    try {
      if (editingSupportingAsset) {
        // Mode √©dition
        saveCurrentState();
        const updatedAsset = {
          ...editingSupportingAsset,
          ...data,
          updatedAt: new Date().toISOString()
        };

        // Mise √† jour Firebase
        await updateSupportingAsset(editingSupportingAsset.id, updatedAsset);

        // Mise √† jour locale
        const updatedAssets = supportingAssets.map(a =>
          a.id === editingSupportingAsset.id ? updatedAsset : a
        );
        dispatch(setSupportingAssets(updatedAssets));
        setEditingSupportingAsset(null);
        setError('‚úÖ Actif support modifi√© avec succ√®s');

        // üîÑ MISE √Ä JOUR MANUELLE SIMPLE
        console.log('üîÑ Modification actif support d√©tect√©e - Mise √† jour manuelle');

        // Lancer une nouvelle analyse apr√®s un d√©lai
        setTimeout(() => {
          console.log('üîç Re-analyse apr√®s modification actif support');
          analyzeDataQuality(businessValues, dreadedEvents, supportingAssets)
            .then(() => console.log('‚úÖ Re-analyse termin√©e'))
            .catch(error => console.error('‚ùå Erreur re-analyse:', error));
        }, 1000);
      } else {
        // Mode cr√©ation
        const newAsset = await createSupportingAsset({
          name: data.name || '',
          type: data.type || 'software',
          description: data.description || '',
          securityLevel: data.securityLevel || 'internal',
          businessValueId: selectedBusinessValueId!,
          missionId: missionId,
          vulnerabilities: [],
          dependsOn: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });

        if (isDevelopment) {
          console.log('‚úÖ Workshop1 - Actif support cr√©√©:', newAsset);
        }

        dispatch(addSupportingAsset(newAsset));
        setError('‚úÖ Actif support cr√©√© avec succ√®s !');
      }

      setIsAddAssetModalOpen(false);
      setSelectedBusinessValueId(null);

      // üîß AM√âLIORATION: Gestion d'erreur avec retry
      await retryOperation(async () => {
        const updatedAssets = await getSupportingAssetsByMission(missionId);
        dispatch(setSupportingAssets(updatedAssets));
        if (isDevelopment) {
          console.log('üîÑ Workshop1 - Actifs supports recharg√©s:', updatedAssets.length);
        }
      }, 3);

    } catch (error) {
      if (isDevelopment) {
        console.error('‚ùå Workshop1 - Erreur lors de la cr√©ation de l\'actif support:', error);
      }
      setError('√âchec de la cr√©ation de l\'actif support. Veuillez r√©essayer.');
    }
  };

  // üÜï AM√âLIORATION: Fonction de retry pour les op√©rations Firebase
  const retryOperation = async (operation: () => Promise<void>, maxRetries: number = 3): Promise<void> => {
    let lastError: Error | null = null;

    for (let attempt = 1; attempt <= maxRetries; attempt++) {
      try {
        await operation();
        return; // Succ√®s
      } catch (error) {
        lastError = error as Error;
        if (attempt < maxRetries) {
          // Attendre avant de r√©essayer (backoff exponentiel)
          await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        }
      }
    }

    throw lastError; // √âchec apr√®s tous les essais
  };

  const handleNext = async () => {
    const requiredCriteria = validationResults.filter(r => r.required);
    const unmetRequiredCriteria = requiredCriteria.filter(r => !r.met);
    
    if (unmetRequiredCriteria.length > 0) {
      setError(`Crit√®res requis non satisfaits : ${unmetRequiredCriteria.map(c => c.criterion).join(', ')}`);
      return false;
    }

    try {
      // Marquer l'atelier 1 comme compl√©t√©
      if (mission) {
        await updateMission(mission.id, {
          ...mission,
          ebiosCompliance: {
            ...mission.ebiosCompliance,
            completionPercentage: 20 // 20% apr√®s atelier 1
          }
        });
      }
      return true;
    } catch (error) {
      console.error('Erreur lors de la sauvegarde:', error);
      setError('Erreur lors de la sauvegarde des donn√©es');
      return false;
    }
  };

  const getGravityColor = (gravity: GravityScale) => {
    switch (gravity) {
      case 1: return 'text-green-600 bg-green-50';
      case 2: return 'text-yellow-600 bg-yellow-50';
      case 3: return 'text-orange-600 bg-orange-50';
      case 4: return 'text-red-600 bg-red-50';
      default: return 'text-gray-600 bg-gray-50';
    }
  };

  const getValidationIcon = (met: boolean, required: boolean) => {
    if (met) return <CheckCircle className="h-5 w-5 text-green-500" />;
    if (required) return <AlertCircle className="h-5 w-5 text-red-500" />;
    return <AlertTriangle className="h-5 w-5 text-yellow-500" />;
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    );
  }

  return (
    <div className="space-y-8">
      {/* üé® EN-T√äTE STANDARDIS√â */}
      <StandardWorkshopHeader
        workshopNumber={1}
        title="Atelier 1 : Cadrage et Socle de S√©curit√©"
        description="D√©finir le p√©rim√®tre d'analyse, identifier les valeurs m√©tier et √©valuer la base de s√©curit√© selon EBIOS RM v1.5"
        missionId={missionId}
        data={{
          businessValues,
          supportingAssets,
          dreadedEvents
        }}
        showHelp={showHelp}
        onToggleHelp={() => setShowHelp(!showHelp)}
        helpContent={
          <>
            <h3 className="font-medium text-gray-900 mb-2">Objectifs de l'Atelier 1 (ANSSI) :</h3>
            <ul className="list-disc list-inside space-y-1 text-sm text-gray-600">
              <li><strong>Valeurs m√©tier :</strong> Identifier ce qui a de la valeur pour l'organisation</li>
              <li><strong>Actifs supports :</strong> Cartographier les √©l√©ments qui supportent les valeurs m√©tier</li>
              <li><strong>√âv√©nements redout√©s :</strong> D√©finir ce que l'on craint qu'il arrive aux valeurs m√©tier</li>
              <li><strong>Socle de s√©curit√© :</strong> √âvaluer les mesures de s√©curit√© existantes</li>
              <li><strong>Parties prenantes :</strong> Identifier les acteurs du p√©rim√®tre d'analyse</li>
            </ul>
          </>
        }
      />

      {/* üìä PANNEAU DE VALIDATION STANDARDIS√â AVEC ACTIONS */}
      {standardValidation && (
        <StandardValidationPanel
          workshopNumber={1}
          validationResults={standardValidation.validationResults}
          businessValues={businessValues}
          supportingAssets={supportingAssets}
          dreadedEvents={dreadedEvents}
          onNavigateToSection={(section) => {
            console.log('üß≠ Navigation vers section:', section);

            // Navigation am√©lior√©e vers les sections sp√©cifiques
            if (section.startsWith('business-value-')) {
              // Navigation vers une valeur m√©tier sp√©cifique
              const businessValueId = section.replace('business-value-', '');
              const element = document.querySelector(`[data-business-value-id="${businessValueId}"]`);
              if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Mettre en √©vidence temporairement
                element.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
                setTimeout(() => {
                  element.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50');
                }, 3000);
              }
            } else {
              // Navigation vers une section g√©n√©rale
              const sectionMap = {
                'business-values': 'business-values-section',
                'supporting-assets': 'supporting-assets-section',
                'dreaded-events': 'dreaded-events-section',
                'security-baseline': 'security-baseline-section'
              };

              const elementId = sectionMap[section as keyof typeof sectionMap] || section;
              const element = document.getElementById(elementId);

              if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
                // Mettre en √©vidence temporairement
                element.classList.add('ring-2', 'ring-blue-500', 'ring-opacity-50');
                setTimeout(() => {
                  element.classList.remove('ring-2', 'ring-blue-500', 'ring-opacity-50');
                }, 3000);
              } else {
                console.warn('‚ö†Ô∏è Section non trouv√©e:', elementId);
                // Fallback : scroll vers le haut
                window.scrollTo({ top: 0, behavior: 'smooth' });
              }
            }
          }}
          onAddBusinessValue={() => setIsAddValueModalOpen(true)}
          onAddDreadedEvent={(businessValueId) => {
            if (businessValueId) {
              setSelectedBusinessValueId(businessValueId);
            }
            setIsAddEventModalOpen(true);
          }}
          onAddSupportingAsset={(businessValueId) => {
            if (businessValueId) {
              setSelectedBusinessValueId(businessValueId);
            }
            setIsAddAssetModalOpen(true);
          }}
          onAutoFix={(criterion) => {
            console.log('ü§ñ Auto-fix demand√© pour:', criterion);

            // Logique de correction automatique am√©lior√©e
            switch (criterion) {
              case 'Valeurs m√©tier identifi√©es':
                setIsAddValueModalOpen(true);
                break;
              case 'Actifs supports cartographi√©s':
                if (businessValues.length > 0) {
                  setSelectedBusinessValueId(businessValues[0].id);
                  setIsAddAssetModalOpen(true);
                } else {
                  setError('‚ö†Ô∏è Ajoutez d\'abord une valeur m√©tier');
                }
                break;
              case '√âv√©nements redout√©s d√©finis':
                if (businessValues.length > 0) {
                  setSelectedBusinessValueId(businessValues[0].id);
                  setIsAddEventModalOpen(true);
                } else {
                  setError('‚ö†Ô∏è Ajoutez d\'abord une valeur m√©tier');
                }
                break;
              case 'Socle de s√©curit√© √©valu√©':
                // Ouvrir le panneau de suggestions IA pour la s√©curit√©
                setSelectedCriterion(criterion);
                setShowAISuggestions(true);
                break;
              default:
                // Ouvrir le panneau de suggestions IA g√©n√©rique
                setSelectedCriterion(criterion);
                setShowAISuggestions(true);
                break;
            }
          }}
        />
      )}

      {/* üîç NOUVEAU : ALERTES DE QUALIT√â DES DONN√âES */}
      {showDataQualityAlert && dataQualityIssues.length > 0 && (
        <div className="mb-6 space-y-4">
          <div className="flex items-center justify-between bg-blue-50 border border-blue-200 rounded-lg p-4">
            <div className="flex items-center gap-3">
              <RefreshCw className="h-5 w-5 text-blue-600" />
              <div>
                <h3 className="font-medium text-blue-900">Analyse de qualit√© des donn√©es</h3>
                <p className="text-sm text-blue-700">
                  <span className="font-bold text-2xl text-red-600">{dataQualityIssues.length}</span> probl√®me{dataQualityIssues.length !== 1 ? 's' : ''} d√©tect√©{dataQualityIssues.length !== 1 ? 's' : ''}
                </p>
                <p className="text-xs text-blue-600 mt-1">
                  üìä Donn√©es: {businessValues?.length || 0} valeurs, {dreadedEvents?.length || 0} √©v√©nements, {supportingAssets?.length || 0} actifs
                </p>
                <p className="text-xs text-blue-600">
                  üîÑ Compteur: {dataChangeCounter} | ‚è∞ Derni√®re analyse: {lastAnalysisTimestamp ? new Date(lastAnalysisTimestamp).toLocaleTimeString() : 'Jamais'}
                </p>
              </div>
            </div>
            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                onClick={() => {
                  console.log('üîÑ Re-analyse manuelle forc√©e');
                  setLastAnalysisTimestamp(0);
                  setDataChangeCounter(prev => prev + 1);
                  analyzeDataQuality(businessValues, dreadedEvents, supportingAssets);
                }}
                className="flex items-center gap-2"
              >
                <RefreshCw className="h-4 w-4" />
                Actualiser l'analyse
              </Button>

              <Button
                variant="secondary"
                size="sm"
                onClick={(e) => {
                  e.preventDefault();
                  e.stopPropagation();

                  try {
                    console.log('üß™ TEST DIAGNOSTIC - √âtat actuel:');
                    console.log('üìä businessValues:', businessValues?.length || 0, businessValues);
                    console.log('üìä dreadedEvents:', dreadedEvents?.length || 0, dreadedEvents);
                    console.log('üìä supportingAssets:', supportingAssets?.length || 0, supportingAssets);
                    console.log('üìä dataQualityIssues:', dataQualityIssues?.length || 0, dataQualityIssues);
                    console.log('üìä dataChangeCounter:', dataChangeCounter);
                    console.log('üìä lastAnalysisTimestamp:', lastAnalysisTimestamp ? new Date(lastAnalysisTimestamp).toLocaleTimeString() : 'Jamais');

                    // Test direct de l'analyse
                    console.log('üß™ Lancement analyse directe...');
                    if (typeof analyzeDataQuality === 'function') {
                      analyzeDataQuality(businessValues || [], dreadedEvents || [], supportingAssets || [])
                        .then(() => console.log('‚úÖ Analyse termin√©e'))
                        .catch(error => console.error('‚ùå Erreur analyse:', error));
                    } else {
                      console.error('‚ùå analyzeDataQuality n\'est pas une fonction');
                    }
                  } catch (error) {
                    console.error('‚ùå Erreur dans le diagnostic:', error);
                  }
                }}
                className="flex items-center gap-2"
              >
                üß™ Test Diagnostic
              </Button>

              <button
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#ef4444',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer',
                  marginRight: '8px'
                }}
                onClick={() => {
                  try {
                    console.log('üî• TEST SIMPLE - Clic d√©tect√© !');
                    alert('Test simple fonctionne !');
                  } catch (error) {
                    console.error('Erreur test simple:', error);
                    alert('Erreur: ' + (error as Error).message);
                  }
                }}
              >
                üî• Test Simple
              </button>

              <button
                style={{
                  padding: '8px 16px',
                  backgroundColor: '#3b82f6',
                  color: 'white',
                  border: 'none',
                  borderRadius: '4px',
                  cursor: 'pointer'
                }}
                onClick={() => {
                  try {
                    console.log('üîç LANCEMENT ANALYSE MANUELLE');
                    console.log('üìä Donn√©es:', {
                      businessValues: businessValues?.length || 0,
                      dreadedEvents: dreadedEvents?.length || 0,
                      supportingAssets: supportingAssets?.length || 0
                    });

                    // Lancer l'analyse directement
                    analyzeDataQuality(businessValues || [], dreadedEvents || [], supportingAssets || [])
                      .then(() => {
                        console.log('‚úÖ Analyse termin√©e avec succ√®s');
                        alert('Analyse termin√©e ! V√©rifiez la console et le compteur.');
                      })
                      .catch(error => {
                        console.error('‚ùå Erreur analyse:', error);
                        alert('Erreur analyse: ' + error.message);
                      });
                  } catch (error) {
                    console.error('‚ùå Erreur bouton analyse:', error);
                    alert('Erreur bouton: ' + (error as Error).message);
                  }
                }}
              >
                üîç Lancer Analyse
              </button>
            </div>
          </div>

          <DataQualityAlert
            issues={dataQualityIssues}
            onAutoFix={handleAutoFixDataQuality}
            onManualFix={handleManualFixDataQuality}
            onDismiss={handleDismissDataQualityIssue}
            onRestoreOriginal={handleRestoreOriginalValue} // üîÑ NOUVEAU
          />
        </div>
      )}

      {/* üìã GUIDE UTILISATEUR AM√âLIOR√â */}
      <Workshop1Guide
        businessValues={businessValues}
        dreadedEvents={dreadedEvents}
        supportingAssets={supportingAssets}
        onAddBusinessValue={() => setIsAddValueModalOpen(true)}
        onAddDreadedEvent={(businessValueId) => {
          setSelectedBusinessValueId(businessValueId);
          setIsAddEventModalOpen(true);
        }}
        onAddSupportingAsset={(businessValueId) => {
          setSelectedBusinessValueId(businessValueId);
          setIsAddAssetModalOpen(true);
        }}
      />

      {error && (
        <div className={`rounded-md p-4 ${error.includes('üí°') ? 'bg-blue-50 border border-blue-200' : 'bg-red-50'}`}>
          <div className="flex">
            <div className="ml-3">
              <h3 className={`text-sm font-medium ${error.includes('üí°') ? 'text-blue-800' : 'text-red-800'}`}>
                {error}
              </h3>
            </div>
          </div>
        </div>
      )}

      {/* üîß NOUVEAU LAYOUT: Structure en sections verticales pour meilleure lisibilit√© */}
      <div className="space-y-8">

        {/* Section Valeurs M√©tier - Layout am√©lior√© */}
        <div id="business-values-section" className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200 bg-blue-50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <Database className="h-5 w-5 text-blue-600" />
                </div>
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Valeurs M√©tier</h2>
                  <p className="text-sm text-gray-600">Identifiez ce qui a de la valeur pour votre organisation</p>
                </div>
              </div>
              <Button
                onClick={() => setIsAddValueModalOpen(true)}
                className="flex items-center space-x-2"
              >
                <Plus className="h-4 w-4" />
                <span>Ajouter une valeur</span>
              </Button>
            </div>
          </div>

          <div className="p-6">
            {businessValues.length === 0 ? (
              <div className="text-center py-12">
                <Database className="mx-auto h-16 w-16 text-gray-300" />
                <h3 className="mt-4 text-lg font-medium text-gray-900">Aucune valeur m√©tier d√©finie</h3>
                <p className="mt-2 text-gray-600 max-w-md mx-auto">
                  Commencez par identifier les valeurs m√©tier de votre organisation.
                  Ces √©l√©ments repr√©sentent ce qui est important pour votre activit√©.
                </p>
                <div className="mt-6">
                  <Button onClick={() => setIsAddValueModalOpen(true)} size="lg">
                    <Plus className="h-5 w-5 mr-2" />
                    Ajouter votre premi√®re valeur m√©tier
                  </Button>
                </div>
              </div>
            ) : (
              <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                {businessValues.map((value) => (
                  <div
                    key={value.id}
                    data-business-value-id={value.id}
                    className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow"
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex-1 min-w-0">
                        <h3 className="font-medium text-gray-900 truncate">{value.name}</h3>
                        <p className="text-sm text-gray-600 mt-1 line-clamp-2">{value.description}</p>
                      </div>
                      <div className="flex space-x-1 ml-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setSelectedBusinessValueId(value.id);
                            setIsAddEventModalOpen(true);
                          }}
                          className="p-1"
                          title="Ajouter un √©v√©nement redout√©"
                        >
                          <Target className="h-3 w-3" />
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setSelectedBusinessValueId(value.id);
                            setIsAddAssetModalOpen(true);
                          }}
                          className="p-1"
                          title="Ajouter un actif support"
                        >
                          <Server className="h-3 w-3" />
                        </Button>
                      </div>
                    </div>

                    <div className="space-y-2">
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-500">Cat√©gorie:</span>
                        <span className="text-xs font-medium text-gray-700">{value.category}</span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span className="text-xs text-gray-500">Priorit√©:</span>
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${getGravityColor(value.priority)}`}>
                          {EbiosUtils.formatScaleLabel('gravity', value.priority)}
                        </span>
                      </div>
                    </div>

                    {/* Compteurs d'√©l√©ments associ√©s */}
                    <div className="mt-3 pt-3 border-t border-gray-100">
                      <div className="flex items-center justify-between text-xs">
                        <div className="flex items-center space-x-3">
                          <span className="flex items-center space-x-1">
                            <Target className="h-3 w-3 text-red-500" />
                            <span>{dreadedEvents.filter(e => e.businessValueId === value.id).length} ER</span>
                          </span>
                          <span className="flex items-center space-x-1">
                            <Server className="h-3 w-3 text-green-500" />
                            <span>{supportingAssets.filter(a => a.businessValueId === value.id).length} AS</span>
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>

        {/* Section √âv√©nements Redout√©s - Layout am√©lior√© */}
        <div id="dreaded-events-section" className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200 bg-red-50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="p-2 bg-red-100 rounded-lg">
                  <AlertTriangle className="h-5 w-5 text-red-600" />
                </div>
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">√âv√©nements Redout√©s</h2>
                  <p className="text-sm text-gray-600">Ce que vous craignez qu'il arrive √† vos valeurs m√©tier</p>
                </div>
              </div>
              <div className="text-sm text-gray-500">
                {dreadedEvents.length} √©v√©nement{dreadedEvents.length !== 1 ? 's' : ''} d√©fini{dreadedEvents.length !== 1 ? 's' : ''}
              </div>
            </div>
          </div>

          <div className="p-6">
            {dreadedEvents.length === 0 ? (
              <div className="text-center py-12">
                <AlertTriangle className="mx-auto h-16 w-16 text-gray-300" />
                <h3 className="mt-4 text-lg font-medium text-gray-900">Aucun √©v√©nement redout√© d√©fini</h3>
                <p className="mt-2 text-gray-600 max-w-md mx-auto">
                  Les √©v√©nements redout√©s repr√©sentent ce que vous craignez qu'il arrive √† vos valeurs m√©tier.
                  Ils sont cr√©√©s depuis les valeurs m√©tier.
                </p>
                <div className="mt-6">
                  <p className="text-sm text-gray-500">
                    üí° Astuce : Cliquez sur le bouton <Target className="inline h-4 w-4 mx-1" /> √† c√¥t√© d'une valeur m√©tier pour ajouter un √©v√©nement redout√©
                  </p>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                {/* Groupement par valeur m√©tier */}
                {businessValues.map((value) => {
                  const relatedEvents = dreadedEvents.filter(e => e.businessValueId === value.id);
                  if (relatedEvents.length === 0) return null;

                  return (
                    <div key={value.id} className="border border-gray-200 rounded-lg">
                      <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                        <h3 className="font-medium text-gray-900 flex items-center">
                          <Database className="h-4 w-4 text-blue-500 mr-2" />
                          {value.name}
                        </h3>
                      </div>
                      <div className="p-4 space-y-3">
                        {relatedEvents.map((event) => (
                          <div key={event.id} className="flex items-start space-x-3 p-3 bg-red-25 rounded-lg border border-red-100">
                            <AlertTriangle className="h-4 w-4 text-red-500 mt-0.5 flex-shrink-0" />
                            <div className="flex-1 min-w-0">
                              <h4 className="font-medium text-gray-900">{event.name}</h4>
                              <p className="text-sm text-gray-600 mt-1">{event.description}</p>
                              <div className="flex items-center space-x-4 mt-2">
                                <span className="text-xs text-gray-500">
                                  Impact: <span className="font-medium">{IMPACT_TYPES[event.impactType]}</span>
                                </span>
                                <span className={`px-2 py-1 rounded-full text-xs font-medium ${getGravityColor(event.gravity)}`}>
                                  Gravit√©: {EbiosUtils.formatScaleLabel('gravity', event.gravity)}
                                </span>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>

        {/* Section Actifs Supports - Layout am√©lior√© */}
        <div id="supporting-assets-section" className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200 bg-green-50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="p-2 bg-green-100 rounded-lg">
                  <Server className="h-5 w-5 text-green-600" />
                </div>
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Actifs Supports</h2>
                  <p className="text-sm text-gray-600">√âl√©ments qui supportent et permettent vos valeurs m√©tier</p>
                </div>
              </div>
              <div className="text-sm text-gray-500">
                {supportingAssets.length} actif{supportingAssets.length !== 1 ? 's' : ''} identifi√©{supportingAssets.length !== 1 ? 's' : ''}
              </div>
            </div>
          </div>

          <div className="p-6">
            {supportingAssets.length === 0 ? (
              <div className="text-center py-12">
                <Server className="mx-auto h-16 w-16 text-gray-300" />
                <h3 className="mt-4 text-lg font-medium text-gray-900">Aucun actif support d√©fini</h3>
                <p className="mt-2 text-gray-600 max-w-md mx-auto">
                  Les actifs supports sont les √©l√©ments techniques, organisationnels ou humains
                  qui permettent de r√©aliser vos valeurs m√©tier.
                </p>
                <div className="mt-6">
                  <p className="text-sm text-gray-500">
                    üí° Astuce : Cliquez sur le bouton <Server className="inline h-4 w-4 mx-1" /> √† c√¥t√© d'une valeur m√©tier pour ajouter un actif support
                  </p>
                </div>
              </div>
            ) : (
              <div className="space-y-4">
                {/* Groupement par valeur m√©tier */}
                {businessValues.map((value) => {
                  const relatedAssets = supportingAssets.filter(a => a.businessValueId === value.id);
                  if (relatedAssets.length === 0) return null;

                  return (
                    <div key={value.id} className="border border-gray-200 rounded-lg">
                      <div className="px-4 py-3 bg-gray-50 border-b border-gray-200">
                        <h3 className="font-medium text-gray-900 flex items-center">
                          <Database className="h-4 w-4 text-blue-500 mr-2" />
                          {value.name}
                        </h3>
                      </div>
                      <div className="p-4">
                        <div className="grid gap-3 md:grid-cols-2">
                          {relatedAssets.map((asset) => (
                            <div key={asset.id} className="flex items-start space-x-3 p-3 bg-green-25 rounded-lg border border-green-100">
                              <Server className="h-4 w-4 text-green-500 mt-0.5 flex-shrink-0" />
                              <div className="flex-1 min-w-0">
                                <h4 className="font-medium text-gray-900">{asset.name}</h4>
                                <p className="text-sm text-gray-600 mt-1 line-clamp-2">{asset.description}</p>
                                <div className="flex items-center space-x-3 mt-2">
                                  <span className="text-xs text-gray-500">
                                    Type: <span className="font-medium">{SUPPORTING_ASSET_TYPES[asset.type]}</span>
                                  </span>
                                  <span className="text-xs text-gray-500">
                                    Classification: <span className="font-medium">{SECURITY_LEVELS[asset.securityLevel]}</span>
                                  </span>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>

        {/* üÜï ACTIONS DE GESTION: Modification, suppression, r√©initialisation */}
        <Workshop1Actions
          businessValues={businessValues}
          supportingAssets={supportingAssets}
          dreadedEvents={dreadedEvents}
          onEditBusinessValue={handleEditBusinessValue}
          onDeleteBusinessValue={handleDeleteBusinessValue}
          onEditSupportingAsset={handleEditSupportingAsset}
          onDeleteSupportingAsset={handleDeleteSupportingAsset}
          onEditDreadedEvent={handleEditDreadedEvent}
          onDeleteDreadedEvent={handleDeleteDreadedEvent}
          onResetWorkshop={handleResetWorkshop}
          onRestorePrevious={handleRestorePrevious}
          hasPreviousState={previousState !== null}
        />

        {/* üõ°Ô∏è Section Socle de S√©curit√© */}
        <div id="security-baseline" className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200 bg-blue-50">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                <div className="p-2 bg-blue-100 rounded-lg">
                  <Shield className="h-5 w-5 text-blue-600" />
                </div>
                <div>
                  <h2 className="text-lg font-semibold text-gray-900">Socle de S√©curit√©</h2>
                  <p className="text-sm text-gray-600">√âvaluation des mesures de s√©curit√© existantes</p>
                </div>
              </div>
              <div className="text-sm text-gray-500">
                {supportingAssets.filter(a => a.securityLevel).length}/{supportingAssets.length} actifs √©valu√©s
              </div>
            </div>
          </div>

          <div className="p-6">
            {supportingAssets.length === 0 ? (
              <div className="text-center py-12">
                <Shield className="mx-auto h-16 w-16 text-gray-300" />
                <h3 className="mt-4 text-lg font-medium text-gray-900">Aucun actif √† √©valuer</h3>
                <p className="mt-2 text-gray-600 max-w-md mx-auto">
                  Cr√©ez d'abord des actifs supports pour pouvoir √©valuer votre socle de s√©curit√©.
                </p>
              </div>
            ) : (
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                  {supportingAssets.map((asset) => (
                    <div
                      key={asset.id}
                      className={`p-4 border rounded-lg ${
                        asset.securityLevel
                          ? 'border-green-200 bg-green-50'
                          : 'border-yellow-200 bg-yellow-50'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <h4 className="font-medium text-gray-900">{asset.name}</h4>
                          <p className="text-sm text-gray-600 mt-1">{asset.type}</p>
                          {asset.securityLevel ? (
                            <div className="mt-2">
                              <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                                asset.securityLevel === 'secret'
                                  ? 'bg-red-100 text-red-800'
                                  : asset.securityLevel === 'confidential'
                                  ? 'bg-yellow-100 text-yellow-800'
                                  : asset.securityLevel === 'internal'
                                  ? 'bg-blue-100 text-blue-800'
                                  : 'bg-green-100 text-green-800'
                              }`}>
                                {asset.securityLevel === 'secret' && 'üî¥ Secret'}
                                {asset.securityLevel === 'confidential' && 'üü° Confidentiel'}
                                {asset.securityLevel === 'internal' && 'üîµ Interne'}
                                {asset.securityLevel === 'public' && 'üü¢ Public'}
                              </span>
                            </div>
                          ) : (
                            <div className="mt-2">
                              <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                ‚ö™ Non √©valu√©
                              </span>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {supportingAssets.filter(a => !a.securityLevel).length > 0 && (
                  <div className="mt-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <div className="flex items-start">
                      <AlertTriangle className="h-5 w-5 text-yellow-500 mt-0.5" />
                      <div className="ml-3">
                        <h3 className="text-sm font-medium text-yellow-800">
                          ‚ö†Ô∏è √âvaluation incompl√®te
                        </h3>
                        <p className="text-sm text-yellow-700 mt-1">
                          {supportingAssets.filter(a => !a.securityLevel).length} actif(s) support n'ont pas encore √©t√© √©valu√©s.
                          Cliquez sur "Modifier" pour d√©finir leur niveau de criticit√©.
                        </p>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>

        {/* üÜï NOUVEAUX COMPOSANTS IA AM√âLIOR√âS */}

        {/* Dashboard IA Unifi√© */}
        {showAIDashboard && (
          <AIOverviewDashboard
            missionId={missionId}
            className="mb-6"
          />
        )}

        {/* Graphique de D√©pendances */}
        {showDependencyGraph && (
          <DependencyGraph
            missionId={missionId}
            entities={[
              ...businessValues.map(bv => ({
                id: bv.id,
                name: bv.name,
                type: 'businessValue' as const,
                workshop: 1,
                criticality: bv.criticalityLevel as any,
                validationStatus: 'valid' as const
              })),
              ...supportingAssets.map(sa => ({
                id: sa.id,
                name: sa.name,
                type: 'supportingAsset' as const,
                workshop: 1,
                criticality: sa.securityLevel as any,
                validationStatus: 'valid' as const
              })),
              ...dreadedEvents.map(de => ({
                id: de.id,
                name: de.name,
                type: 'dreadedEvent' as const,
                workshop: 1,
                criticality: 'high' as const,
                validationStatus: 'valid' as const
              }))
            ]}
            relationships={[
              ...supportingAssets.map(sa => ({
                id: `supports-${sa.id}`,
                source: sa.id,
                target: sa.businessValueId,
                type: 'protects' as const,
                strength: 0.8,
                aiGenerated: false
              })),
              ...dreadedEvents.map(de => ({
                id: `threatens-${de.id}`,
                source: de.id,
                target: de.businessValueId,
                type: 'threatens' as const,
                strength: 0.7,
                aiGenerated: false
              }))
            ]}
            suggestions={[
              {
                id: 'missing-asset-link',
                type: 'missing_link',
                description: 'Certaines valeurs m√©tier manquent d\'actifs supports',
                confidence: 0.85,
                impact: 'high',
                entities: businessValues.filter(bv =>
                  !supportingAssets.some(sa => sa.businessValueId === bv.id)
                ).map(bv => bv.id)
              }
            ]}
            className="mb-6"
          />
        )}

        {/* Panneau de Guidance */}
        {showGuidancePanel && (
          <EbiosGuidancePanel
            workshop={1}
            currentStep="business-values"
            currentData={{
              businessValues,
              supportingAssets,
              dreadedEvents
            }}
            isCollapsed={guidancePanelCollapsed}
            onToggleCollapse={() => setGuidancePanelCollapsed(!guidancePanelCollapsed)}
            className="mb-6"
          />
        )}

        {/* M√©triques de Qualit√© */}
        {showQualityMetrics && (
          <QualityMetricsPanel
            missionId={missionId}
            workshop={1}
            data={{
              businessValues,
              supportingAssets,
              dreadedEvents
            }}
            className="mb-6"
          />
        )}

        {/* Boutons de contr√¥le des nouveaux composants */}
        <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
          <div className="flex items-center justify-between">
            <h3 className="text-lg font-semibold text-gray-900">üöÄ Fonctionnalit√©s IA Avanc√©es</h3>
            <div className="flex space-x-2">
              <Button
                variant={showAIDashboard ? "default" : "outline"}
                size="sm"
                onClick={() => setShowAIDashboard(!showAIDashboard)}
              >
                üìä Dashboard IA
              </Button>
              <Button
                variant={showDependencyGraph ? "default" : "outline"}
                size="sm"
                onClick={() => setShowDependencyGraph(!showDependencyGraph)}
              >
                üï∏Ô∏è Graphique Relations
              </Button>
              <Button
                variant={showGuidancePanel ? "default" : "outline"}
                size="sm"
                onClick={() => setShowGuidancePanel(!showGuidancePanel)}
              >
                üìñ Guidance EBIOS RM
              </Button>
              <Button
                variant={showQualityMetrics ? "default" : "outline"}
                size="sm"
                onClick={() => setShowQualityMetrics(!showQualityMetrics)}
              >
                üìä M√©triques Qualit√©
              </Button>
            </div>
          </div>
        </div>

        {/* üìä R√©sum√© et M√©triques */}
        <div className="bg-white rounded-lg shadow-sm border border-gray-200">
          <div className="px-6 py-4 border-b border-gray-200">
            <h2 className="text-lg font-semibold text-gray-900">R√©sum√© de l'Atelier 1</h2>
          </div>
          <div className="p-6">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="text-center p-4 bg-blue-50 rounded-lg">
                <Database className="h-8 w-8 text-blue-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-blue-600">{businessValues.length}</div>
                <div className="text-sm text-gray-600">Valeur{businessValues.length !== 1 ? 's' : ''} M√©tier</div>
              </div>
              <div className="text-center p-4 bg-red-50 rounded-lg">
                <AlertTriangle className="h-8 w-8 text-red-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-red-600">{dreadedEvents.length}</div>
                <div className="text-sm text-gray-600">√âv√©nement{dreadedEvents.length !== 1 ? 's' : ''} Redout√©{dreadedEvents.length !== 1 ? 's' : ''}</div>
              </div>
              <div className="text-center p-4 bg-green-50 rounded-lg">
                <Server className="h-8 w-8 text-green-600 mx-auto mb-2" />
                <div className="text-2xl font-bold text-green-600">{supportingAssets.length}</div>
                <div className="text-sm text-gray-600">Actif{supportingAssets.length !== 1 ? 's' : ''} Support{supportingAssets.length !== 1 ? 's' : ''}</div>
              </div>
            </div>
          </div>
        </div>

        {/* üîç Validation M√©thodologique EBIOS RM */}
        <EbiosMethodologyValidator
          businessValues={businessValues}
          dreadedEvents={dreadedEvents}
          supportingAssets={supportingAssets}
          workshopNumber={1}
        />
      </div>

      {/* üÜï AM√âLIORATION: Suggestions IA clarifi√©es et expliqu√©es */}
      {showSuggestions && enhancedSuggestions.length > 0 && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <div className="sticky top-0 bg-white border-b border-gray-200 px-6 py-4">
              <div className="flex items-center justify-between">
                <h3 className="text-xl font-semibold text-gray-900">
                  üß† Suggestions IA pour votre Workshop
                </h3>
                <button
                  onClick={() => setShowSuggestions(false)}
                  className="text-gray-400 hover:text-gray-600 text-xl font-bold"
                >
                  ‚úï
                </button>
              </div>
            </div>

            <div className="p-6">
              <AISuggestionsExplainer
                suggestions={enhancedSuggestions}
                type={(selectedSuggestion?.type === 'riskSource' || selectedSuggestion?.type === 'riskObjective' || selectedSuggestion?.type === 'operationalMode') ? 'securityMeasure' : (selectedSuggestion?.type as 'dreadedEvent' | 'supportingAsset' | 'securityMeasure') || 'dreadedEvent'}
                onApplySuggestion={(suggestion) => {
                  // Logique pour appliquer la suggestion
                  if (suggestion.type === 'dreadedEvent') {
                    setIsAddEventModalOpen(true);
                  } else if (suggestion.type === 'supportingAsset') {
                    setIsAddAssetModalOpen(true);
                  }
                  setShowSuggestions(false);
                }}
              />
            </div>
          </div>
        </div>
      )}

      {/* Modales pour l'ajout/√©dition des entit√©s EBIOS RM */}
      <AddBusinessValueModal
        isOpen={isAddValueModalOpen}
        onClose={() => {
          setIsAddValueModalOpen(false);
          setEditingBusinessValue(null);
        }}
        onSubmit={handleCreateBusinessValue}
        missionId={missionId}
        initialData={editingBusinessValue || undefined}
      />

      <AddDreadedEventModal
        isOpen={isAddEventModalOpen}
        onClose={() => {
          setIsAddEventModalOpen(false);
          setSelectedBusinessValueId(null);
          setEditingDreadedEvent(null);
        }}
        onSubmit={handleCreateDreadedEvent}
        missionId={missionId}
        businessValues={businessValues}
        supportingAssets={supportingAssets}
        existingEvent={editingDreadedEvent || undefined}
      />

      {(selectedBusinessValueId || editingSupportingAsset) && (
        <AddSupportingAssetModal
          isOpen={isAddAssetModalOpen}
          onClose={() => {
            setIsAddAssetModalOpen(false);
            setSelectedBusinessValueId(null);
            setEditingSupportingAsset(null);
          }}
          onSubmit={handleCreateSupportingAsset}
          businessValueId={selectedBusinessValueId || editingSupportingAsset?.businessValueId || ''}
          initialData={editingSupportingAsset || undefined}
        />
      )}

      <WorkshopNavigation
        currentWorkshop={1}
        totalWorkshops={5}
        onNext={handleNext}
      />

      {/* üÜï AM√âLIORATION: Tutoriel guid√© pour nouveaux utilisateurs */}
      <Workshop1Tutorial
        isOpen={showTutorial}
        onClose={() => setShowTutorial(false)}
        onStepComplete={(stepId) => {
          // Optionnel : tracker les √©tapes compl√©t√©es
          if (import.meta.env.DEV) {
            console.log(`√âtape tutoriel compl√©t√©e: ${stepId}`);
          }
        }}
      />

      {/* üÜï AM√âLIORATION: Rapport de validation ANSSI */}
      {showAnssiReport && anssiValidation && (
        <ANSSIValidationReport
          validation={anssiValidation}
          workshop={1}
          onClose={() => setShowAnssiReport(false)}
          missionData={mission ? {
            id: mission.id,
            name: mission.name,
            description: mission.description || ''
          } : undefined}
          workshopData={{
            businessValues,
            supportingAssets,
            dreadedEvents
          }}
          onExport={() => {
            if (import.meta.env.DEV) {
              console.log('Export personnalis√© du rapport ANSSI');
            }
          }}
        />
      )}

      {/* ü§ñ PANNEAU SUGGESTIONS IA POUR CORRECTION AUTOMATIQUE */}
      {showAISuggestions && (
        <AISuggestionPanel
          criterion={selectedCriterion}
          businessValues={businessValues}
          supportingAssets={supportingAssets}
          dreadedEvents={dreadedEvents}
          onClose={() => setShowAISuggestions(false)}
          onApplySuggestion={(suggestion) => {
            setError(`‚úÖ Suggestion appliqu√©e : ${suggestion.title}`);
          }}
          callbacks={{
            onAddBusinessValue: () => {
              setShowAISuggestions(false);
              setIsAddValueModalOpen(true);
            },
            onAddSupportingAsset: (businessValueId) => {
              setShowAISuggestions(false);
              if (businessValueId) {
                setSelectedBusinessValueId(businessValueId);
              }
              setIsAddAssetModalOpen(true);
            },
            onAddDreadedEvent: (businessValueId) => {
              setShowAISuggestions(false);
              if (businessValueId) {
                setSelectedBusinessValueId(businessValueId);
              }
              setIsAddEventModalOpen(true);
            },
            onNavigateToSection: (section) => {
              setShowAISuggestions(false);
              const element = document.getElementById(section);
              if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'start' });
              }
            }
          }}
        />
      )}

      {/* üîß NOUVEAU : MODAL DE CORRECTION MANUELLE */}
      <DataQualityFixModal
        isOpen={showDataQualityFixModal}
        onClose={() => {
          setShowDataQualityFixModal(false);
          setSelectedDataQualityIssue(null);
          setEntityToFix(null);
        }}
        issue={selectedDataQualityIssue}
        entity={entityToFix}
        onSave={handleSaveDataQualityFix}
        entityType={selectedDataQualityIssue?.entityType || 'businessValue'}
      />
    </div>
  );
};

export default Workshop1;