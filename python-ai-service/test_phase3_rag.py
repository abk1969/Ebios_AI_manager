#!/usr/bin/env python3
"""
üß™ TEST PHASE 3 : RAG ET BASE DE CONNAISSANCES
Test complet des services RAG et traitement de documents
"""

import asyncio
import json
import sys
from datetime import datetime

def test_rag_service_import():
    """Test d'import du service RAG"""
    print("üß™ TEST IMPORT SERVICE RAG")
    print("-" * 30)
    
    try:
        from services.ebios_rag_service import EbiosRAGServiceFactory, RAGQueryResult
        print("‚úÖ Import EbiosRAGServiceFactory: OK")
        
        from services.document_processor import DocumentProcessorFactory, DocumentProcessingResult
        print("‚úÖ Import DocumentProcessorFactory: OK")
        
        return True
        
    except ImportError as e:
        print(f"‚ùå Erreur import: {e}")
        return False

def test_rag_service_creation():
    """Test de cr√©ation du service RAG"""
    print("\nüìö TEST CR√âATION SERVICE RAG")
    print("-" * 35)
    
    try:
        from services.ebios_rag_service import EbiosRAGServiceFactory
        
        rag_service = EbiosRAGServiceFactory.create()
        print("‚úÖ Service RAG cr√©√© avec succ√®s")
        
        # Test des capacit√©s
        capabilities = rag_service.get_capabilities()
        print(f"‚úÖ Capacit√©s RAG:")
        for cap, available in capabilities.items():
            print(f"   {available and '‚úÖ' or '‚ö†Ô∏è'} {cap}")
        
        # Test des statistiques de la base de connaissances
        stats = rag_service.get_knowledge_stats()
        print(f"‚úÖ Base de connaissances:")
        print(f"   Documents: {stats['total_documents']}")
        print(f"   Cat√©gories: {list(stats['categories'].keys())}")
        print(f"   Longueur moyenne: {stats['average_content_length']} caract√®res")
        
        # Test de l'√©tat
        is_ready = rag_service.is_ready()
        print(f"‚úÖ √âtat pr√™t: {is_ready}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur cr√©ation: {e}")
        return False

def test_document_processor():
    """Test du processeur de documents"""
    print("\nüìÑ TEST PROCESSEUR DE DOCUMENTS")
    print("-" * 40)
    
    try:
        from services.document_processor import DocumentProcessorFactory
        
        processor = DocumentProcessorFactory.create()
        print("‚úÖ Processeur de documents cr√©√© avec succ√®s")
        
        # Test des capacit√©s
        capabilities = processor.get_capabilities()
        print(f"‚úÖ Capacit√©s processeur:")
        for cap, available in capabilities.items():
            print(f"   {available and '‚úÖ' or '‚ö†Ô∏è'} {cap}")
        
        # Test des statistiques
        stats = processor.get_processing_stats()
        print(f"‚úÖ Statistiques traitement:")
        print(f"   Formats support√©s: {stats['supported_formats']}")
        print(f"   Documents trait√©s: {stats['total_documents_processed']}")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur processeur: {e}")
        return False

async def test_rag_knowledge_queries():
    """Test des requ√™tes √† la base de connaissances"""
    print("\nüìö TEST REQU√äTES BASE DE CONNAISSANCES")
    print("-" * 45)
    
    try:
        from services.ebios_rag_service import EbiosRAGServiceFactory
        
        # Cr√©er le service RAG
        rag_service = EbiosRAGServiceFactory.create()
        print("‚úÖ Service RAG cr√©√©")
        
        # Construire l'index vectoriel
        index_built = await rag_service.build_vector_index()
        print(f"‚úÖ Index vectoriel: {'Construit' if index_built else 'Mode fallback'}")
        
        # Test de requ√™tes EBIOS RM
        test_queries = [
            "Comment d√©finir les valeurs m√©tier en EBIOS RM ?",
            "Quelle est la diff√©rence entre biens essentiels et biens supports ?",
            "Quelles sont les bonnes pratiques pour l'Atelier 1 ?",
            "Comment identifier les √©v√©nements redout√©s ?",
            "Quels sont les crit√®res de s√©curit√© EBIOS RM ?"
        ]
        
        print(f"‚úÖ Test de {len(test_queries)} requ√™tes:")
        
        for i, query in enumerate(test_queries, 1):
            print(f"\n   üîç Requ√™te {i}: {query}")
            
            # Contexte de test
            context = {
                "current_step": "business-values",
                "user_experience": 0.6
            }
            
            # Ex√©cuter la requ√™te RAG
            result = await rag_service.query_ebios_knowledge(query, context)
            
            print(f"   ‚úÖ R√©ponse (confiance: {result.confidence:.2f}):")
            print(f"      {result.response[:100]}...")
            print(f"   üìö Sources: {len(result.sources)}")
            
            if result.sources:
                for source in result.sources[:2]:  # Limiter l'affichage
                    print(f"      - {source.get('title', 'N/A')} ({source.get('category', 'N/A')})")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur requ√™tes RAG: {e}")
        import traceback
        traceback.print_exc()
        return False

async def test_document_processing_workflow():
    """Test du workflow de traitement de documents"""
    print("\nüìÑ TEST WORKFLOW TRAITEMENT DOCUMENTS")
    print("-" * 45)
    
    try:
        from services.document_processor import DocumentProcessorFactory
        import tempfile
        import os
        
        # Cr√©er le processeur
        processor = DocumentProcessorFactory.create()
        print("‚úÖ Processeur cr√©√©")
        
        # Cr√©er un document de test
        test_content = """
# Guide EBIOS RM - Atelier 1

## Introduction
L'Atelier 1 d'EBIOS RM permet de d√©finir le cadrage de l'analyse de risque.

## Valeurs M√©tier
Les valeurs m√©tier repr√©sentent ce qui a de la valeur pour l'organisme.
Exemples :
- Continuit√© d'activit√©
- Conformit√© r√©glementaire
- R√©putation

## Biens Essentiels
Les biens essentiels supportent directement les valeurs m√©tier.
Ils peuvent √™tre :
- Des informations
- Des processus
- Du savoir-faire

## Conclusion
L'Atelier 1 est fondamental pour la suite de l'analyse EBIOS RM.
        """
        
        # Cr√©er un fichier temporaire
        with tempfile.NamedTemporaryFile(mode='w', suffix='.md', delete=False, encoding='utf-8') as f:
            f.write(test_content)
            temp_file = f.name
        
        try:
            print(f"‚úÖ Document de test cr√©√©: {os.path.basename(temp_file)}")
            
            # Traiter le document
            result = await processor.process_document(
                temp_file, 
                document_category="guide",
                auto_add_to_rag=True
            )
            
            print(f"‚úÖ Traitement {'r√©ussi' if result.success else '√©chou√©'}")
            
            if result.success:
                print(f"   Titre: {result.title}")
                print(f"   Contenu: {len(result.content)} caract√®res")
                print(f"   Sections: {len(result.extracted_sections)}")
                print(f"   Temps: {result.processing_time:.2f}s")
                
                if result.extracted_sections:
                    print("   Sections extraites:")
                    for section in result.extracted_sections[:3]:
                        print(f"     - {section.title}: {len(section.content)} caract√®res")
            else:
                print(f"   Erreur: {result.error_message}")
            
        finally:
            # Nettoyer le fichier temporaire
            os.unlink(temp_file)
        
        return result.success if 'result' in locals() else False
        
    except Exception as e:
        print(f"‚ùå Erreur traitement documents: {e}")
        return False

async def test_orchestrator_rag_integration():
    """Test d'int√©gration RAG avec l'orchestrateur"""
    print("\nüéº TEST INT√âGRATION RAG ORCHESTRATEUR")
    print("-" * 45)
    
    try:
        from services.workshop1_orchestrator import Workshop1OrchestratorFactory
        
        # Cr√©er l'orchestrateur avec RAG
        orchestrator = Workshop1OrchestratorFactory.create()
        print("‚úÖ Orchestrateur cr√©√©")
        
        # V√©rifier les nouvelles capacit√©s RAG
        capabilities = orchestrator.get_capabilities()
        print("‚úÖ Capacit√©s RAG d√©tect√©es:")
        
        rag_capabilities = [
            "rag_services",
            "rag_llama_index_available",
            "rag_rag_enabled",
            "rag_knowledge_base_loaded",
            "doc_docling_available",
            "doc_rag_integration"
        ]
        
        for cap in rag_capabilities:
            if cap in capabilities:
                status = "‚úÖ" if capabilities[cap] else "‚ö†Ô∏è"
                print(f"   {status} {cap}: {capabilities[cap]}")
        
        # Test d'orchestration compl√®te avec RAG
        mission_id = "test_mission_rag"
        workshop_data = {
            "business_values": [
                {
                    "id": "bv1",
                    "name": "Continuit√© d'activit√©",
                    "description": "Maintien des op√©rations critiques"
                }
            ],
            "essential_assets": [
                {
                    "id": "ea1",
                    "name": "Syst√®me de gestion",
                    "description": "Application critique de gestion"
                }
            ],
            "supporting_assets": [],
            "dreaded_events": [],
            "current_step": "essential-assets"
        }
        
        user_context = {
            "current_step": "essential-assets",
            "user_experience": 0.5,
            "domain_complexity": 0.7
        }
        
        print("‚úÖ Test d'orchestration avec RAG...")
        
        # Orchestration compl√®te avec RAG
        result = await orchestrator.orchestrate_workshop_analysis(
            mission_id=mission_id,
            workshop_data=workshop_data,
            user_context=user_context
        )
        
        print(f"‚úÖ Orchestration avec RAG r√©ussie")
        print(f"   Mission: {result.mission_id}")
        print(f"   Compl√©tion: {result.completion_percentage:.1f}%")
        print(f"   Score qualit√©: {result.quality_score:.1f}")
        print(f"   Suggestions totales: {len(result.suggestions)}")
        
        # V√©rifier si des suggestions RAG sont pr√©sentes
        rag_suggestions = [s for s in result.suggestions if "Conseil expert" in str(s)]
        print(f"   Suggestions RAG: {len(rag_suggestions)}")
        
        if rag_suggestions:
            print("   Exemples de conseils RAG:")
            for suggestion in rag_suggestions[:2]:
                print(f"     - {str(suggestion)[:80]}...")
        
        return True
        
    except Exception as e:
        print(f"‚ùå Erreur int√©gration RAG: {e}")
        import traceback
        traceback.print_exc()
        return False

async def run_phase3_tests():
    """Ex√©cute tous les tests de la Phase 3"""
    print("üß™ TESTS PHASE 3 : RAG ET BASE DE CONNAISSANCES")
    print("=" * 60)
    
    tests = [
        ("Import service RAG", test_rag_service_import),
        ("Cr√©ation service RAG", test_rag_service_creation),
        ("Processeur de documents", test_document_processor),
        ("Requ√™tes base de connaissances", test_rag_knowledge_queries),
        ("Workflow traitement documents", test_document_processing_workflow),
        ("Int√©gration RAG orchestrateur", test_orchestrator_rag_integration)
    ]
    
    passed = 0
    total = len(tests)
    
    for test_name, test_func in tests:
        print(f"\nüîç Test: {test_name}")
        try:
            if asyncio.iscoroutinefunction(test_func):
                result = await test_func()
            else:
                result = test_func()
            
            if result:
                print(f"‚úÖ {test_name}: R√âUSSI")
                passed += 1
            else:
                print(f"‚ùå {test_name}: √âCHOU√â")
                
        except Exception as e:
            print(f"‚ùå {test_name}: ERREUR - {e}")
    
    # Rapport final
    print("\n" + "=" * 60)
    print("üìä RAPPORT FINAL PHASE 3 : RAG ET BASE DE CONNAISSANCES")
    print("=" * 60)
    
    print(f"‚úÖ Tests r√©ussis: {passed}/{total}")
    print(f"‚ùå Tests √©chou√©s: {total - passed}/{total}")
    
    if passed == total:
        print("\nüéâ PHASE 3 COMPL√àTEMENT R√âUSSIE!")
        print("‚úÖ Le service RAG EBIOS RM fonctionne parfaitement")
        print("üìÑ Le traitement de documents est op√©rationnel")
        print("üìö La base de connaissances est accessible")
        print("üéº L'int√©gration avec l'orchestrateur est r√©ussie")
        print("\nüöÄ TOUTES LES PHASES TERMIN√âES AVEC SUCC√àS!")
        print("üéØ L'ORCHESTRATION IA AVANC√âE EST COMPL√àTE!")
    elif passed >= total - 1:
        print("\n‚úÖ PHASE 3 MAJORITAIREMENT R√âUSSIE")
        print("üîß Quelques ajustements mineurs n√©cessaires")
        print("üöÄ L'orchestration IA avanc√©e est op√©rationnelle")
    else:
        print("\n‚ö†Ô∏è PHASE 3 PARTIELLEMENT R√âUSSIE")
        print("üîß V√©rifiez les erreurs ci-dessus")
    
    return passed >= total - 1

if __name__ == "__main__":
    success = asyncio.run(run_phase3_tests())
    sys.exit(0 if success else 1)
